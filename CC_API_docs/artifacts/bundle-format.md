# Artifacts API - Bundle File Format

## Table of Contents
- [Notes](#notes)
- [Creating/Updating Artifacts](#creatingupdating-artifacts)
  - [Bundle File Format](#bundle-file-format)
- [Submitting Bundle Files via HTML](#submitting-bundle-files-via-html)
  - [HTML Form](#html-form)
- [Response](#response)
- [SAP Events](#sap-events)
- [Bundle File Format Version 2](#bundle-file-format-version-2)
  - [Version 2 Changes](#version-2-changes)
  - [Example (Version 2)](#example-version-2)

## Notes

- Replace `user_authentication_token` and `server_hash` with your own credentials where necessary
- Where a domain is included in the example, Data Secure is used
- All validation messages are translated to appear user-friendly

## Creating/Updating Artifacts

### Bundle File Format

Client Central accepts a bundle file for creating or updating one or multiple artifacts at a time. The bundle file is a zip file that contains a `content.json` manifest file in the root path that describes the artifact files and versions.

Here's an example of the fields that Client Central requires in the `content.json` manifest file:

```json
[
  {
    "id": 32,
    "external_id": "any string",
    "type_id": 2,
    "guid": "123456789ABCDEF",
    "domain": "qm",
    "published": true,
    "origin": "certified",
    "original_locale": "en",
    "manual_locales": {
      "name": ["en", "fr", "es"],
      "documentation": ["en", "fr", "es"]
    },
    "keywords": {
      "en": ["Personnel Administration", "QM4", "Pre Payroll Reconciliation"]
    },
    "name": {
      "en": "My data source",
      "fr": "Ma source de données",
      "es": "Mi fuente de datos"
    },
    "documentation": {
      "en": "Some description",
      "fr": "Quelque description",
      "es": "Alguna descripción"
    },
    "depend_on_guids": ["987654321ABCDEF", "987654321FEDCBA"],
    "versions": [
      {
        "version": 3,
        "external_version": "43",
        "created_at": "2013-09-09T13:32:54Z",
        "prod_min_version": 4.0,
        "prod_min_build": 38,
        "path": "qm/data_source/15_data_source_v1.qdef"
      }
    ],
    "created_at": "2015-06-05T16:53:28.190+02:00",
    "updated_at": "2017-07-12T22:12:15.517+02:00"
  }
]
```

### Field Descriptions

| Field | Description |
|-------|-------------|
| `id` | The Client Central ID of this artifact. It is unique across all products and customers. |
| `external_id` | Field provided for convenience purposes. Allows software integrating with Client Central to store their ID of the artifact. |
| `type_id` | Permanent integer ID of the content type (1 = query, 2 = data source, 3 = Policy, etc.). This should be configured in Client Central under the 'Types' menu and then hard-coded in the ABAP product. |
| `guid` | Cross customer, system and client unique identifier generated and supplied by the Labs ABAP product. This field is not mandatory and can be used to determine the identity of an artifact in CC that was transported from a different system and shared on that system after the transport was created. |
| `domain` | DEPRECATED. Included in JSON for legacy purposes (old QM4 transports break without it). |
| `origin` | Where this artifact originated from. Valid values are 'community', 'official' and 'certified' although 'official' has been deprecated. |
| `published` | The published status of the artifact on Client Central. |
| `depend_on_guids` | Artifact guids that this artifact depends on. |
| `original_locale` | The first language the artifact was created in. Usually the language of the author. |
| `manual_locales` | Locales that were translated manually. Client Central may fill in other languages with automatic translation services. |
| `name` | User-supplied artifact name. |
| `documentation` | User-supplied artifact documentation. |
| `versions.prod_min_version & versions.prod_min_build` | The minimum Labs ABAP product version and build required to use this artifact. |
| `versions.version` | Sequential version number generated by Client Central. |
| `versions.external_version` | Field provided for convenience purposes. Allows software integrating with Client Central to store their ID of the artifact. |
| `created_at` | When this artifact was created. |
| `updated_at` | When this artifact was last updated. |

## Submitting Bundle Files via HTML

### HTML Form

```html
<form accept-charset="UTF-8" action="/artifacts/submit?at=user_authentication_token&amp;amp;sh=server_hash" method="post">
  <input type="text" id="bundle_base64" name="bundle_base64" value="PD94bWwgdmVyc2lvbj0iMS4wIiBl" />
  <input type="submit" value="Submit this" />
</form>
```

## Response

- `SAP::Events.success` with json detail of the updated/created artifacts, if the validation succeeded
- `SAP::Events.rejected` with the first error message of either the artifact version object or the artifact as a whole

## SAP Events

A list of possible SAP events is maintained in the GIT repository under:

[http://redmine.labs.epiuse.com/redmine/projects/rails-application-framework/repository/revisions/master/entry/lib/sap/events.rb](http://redmine.labs.epiuse.com/redmine/projects/rails-application-framework/repository/revisions/master/entry/lib/sap/events.rb)

## Bundle File Format Version 2

The purpose of V2 is to make it a generic content format instead of a Client Central format. Multiple bundle formats can be contained in the same ELP archive. A `content.json` in the root indicates V1 is supported. A `content-v2.json` in the root indicates V2 is supported.

### Version 2 Changes

- Izak: name is renamed to description
- Pierre: Introduce `_meta` json field for application-specific properties. Importing and exporting an artifact to your application should preserve this field
- Izak/Johannes: id is moved to `_meta.client_central`
- Izak/Johannes: Introduce a new id that is optional and non-unique
- Izak: Rename `versions.created_at` to `versions.changed_at`
- Pierre: Replace `type_id` with `content_type` mime type

### Example (Version 2)

```json
{
  "id": "Non-unique optional string.  Examples are: VENDOR.",
  "guid": "123456789ABCDEF",
  "content_type": "application/bow",
  "published": true,
  "origin": "certified",
  "original_locale": "en",
  "manual_locales": {
    "name": ["en", "fr", "es"],
    "documentation": ["en", "fr", "es"]
  },
  "keywords": {
    "en": ["Personnel Administration", "QM4", "Pre Payroll Reconciliation"]
  },
  "description": {
    "en": "My content",
    "fr": "Ma données",
    "es": "Mi datos"
  },
  "documentation": {
    "en": "Some description",
    "fr": "Quelque description",
    "es": "Alguna descripción"
  },
  "depend_on_guids": [{ "type": "application/bow", "guid": "vendor" }],
  "versions": [
    {
      "changed_at": "2015-06-05T16:53:28.190+02:00",
      "path": "/path/to/file/in/zip",
      "_meta": {
        "successfactors": { "version": 4 }
      }
    },
    { "...more versions...": "" }
  ],
  "created_at": "2015-06-05T16:53:28.190+02:00",
  "updated_at": "2017-07-12T22:12:15.517+02:00",
  "_meta": {
    "sucessxpress": {
      "schema": "https://successxpress.com/bow/schema1.json",
      "somefield": "somevalue"
    },
    "succesfactors": {},
    "client_central": {
      "schema": "https://clientcentral.io/api/v2/artifacts/schema.json",
      "id": 5,
      "certified": true,
      "content_hash": "DDB3ECB9B43D7C20776C3EADAE2B0996",
      "signature": "DDB3ECB9B43D7C20776C3EADAE2B0996"
    },
    "query_manager": { "id": 4, "sid": "esx" }
  }
}
